name: Build KatelyaTV for Webhostmost

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
          # ❌ 不要使用 cache: npm/yarn
          # cache: 'npm'

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build production
        run: pnpm run build

      - name: Prepare runtime bundle
        run: |
          set -eux
          rm -rf release
          mkdir -p release

          if [ -d ".next/standalone" ]; then
            echo "Using Next.js standalone output..."
            cp -R .next/standalone/* release/

            mkdir -p release/.next
            cp -R .next/static release/.next/static

            if [ -d "public" ]; then
              cp -R public release/public
            fi

            if [ -f "config.json" ]; then
              cp config.json release/config.json
            fi
          else
            echo "Fallback: bundling whole .next + node_modules"

            cp -R .next release/.next

            if [ -d "public" ]; then
              cp -R public release/public
            fi

            if [ -d "node_modules" ]; then
              cp -R node_modules release/node_modules
            fi

            for f in package.json next.config.js start.js config.json; do
              if [ -f "$f" ]; then
                cp "$f" "release/$f"
              fi
            done
          fi

          rm -rf release/src || true
          rm -rf release/tests || true

      - name: Create zip artifact
        run: |
          cd release
          zip -r ../katelyatv-webhostmost.zip .

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: katelyatv-webhostmost
          path: katelyatv-webhostmost.zip
          compression-level: 9
