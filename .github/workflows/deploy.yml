name: Build KatelyaTV for Webhostmost

on:
  # 手动触发（推荐你先用这个调试）
  workflow_dispatch:
  # 或者当你打 tag 的时候自动构建
  push:
    tags:
      - "webhostmost-*"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Enable corepack (pnpm)
        run: corepack enable

      - name: Install dependencies (pnpm)
        run: pnpm install --frozen-lockfile

      - name: Build production
        # 如果后续发现脚本名不是 build，可以改成对应的 pnpm run XXX
        run: pnpm run build

      # 尝试使用 Next.js standalone 产物（如果有）
      - name: Prepare runtime bundle for shared hosting
        run: |
          set -eux

          rm -rf release
          mkdir -p release

          if [ -d ".next/standalone" ]; then
            echo "Detected Next.js standalone output, using it for runtime bundle..."

            # 拷贝 standalone（内含 node_modules、package.json 等）
            cp -R .next/standalone/* release/

            # 拷贝静态资源与 public
            mkdir -p release/.next
            cp -R .next/static release/.next/static

            if [ -d "public" ]; then
              cp -R public release/public
            fi

            # 如果你有自定义 config.json，也一并带上
            if [ -f "config.json" ]; then
              cp config.json release/config.json
            fi
          else
            echo "No .next/standalone found, fallback to basic bundle..."

            # 兜底方案：直接把运行必需目录打包（空间会比较大）
            cp -R .next release/.next

            if [ -d "public" ]; then
              cp -R public release/public
            fi

            if [ -d "node_modules" ]; then
              cp -R node_modules release/node_modules
            fi

            for f in package.json next.config.js start.js config.json; do
              if [ -f "$f" ]; then
                cp "$f" "release/$f"
              fi
            done
          fi

          # 简单删掉源码目录以减少体积（按需再调整）
          rm -rf release/src || true
          rm -rf release/tests || true

      - name: Create zip artifact
        run: |
          cd release
          zip -r ../katelyatv-webhostmost.zip .
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: katelyatv-webhostmost
          path: katelyatv-webhostmost.zip
          compression-level: 9
