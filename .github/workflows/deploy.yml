name: Build and Deploy KatelyaTV Standalone

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 10.12.4
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.19.4'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Generate runtime config
      run: |
        cat > config.production.json << 'EOF'
        {
          "cache_time": 7200,
          "api_site": {
            "hnzy": {
              "api": "https://hnzyapi.com/api.php/provide/vod",
              "name": "ç«é¸Ÿèµ„æº",
              "is_adult": false
            },
            "lzzy": {
              "api": "https://api.liangzizy.com/inc/apijson_vod.php",
              "name": "é‡å­èµ„æº",
              "is_adult": false
            },
            "ffzy": {
              "api": "https://ffzyapi.com/api.php/provide/vod",
              "name": "éå‡¡èµ„æº",
              "is_adult": false
            },
            "ykzy": {
              "api": "https://api.yongjiuzy.cc/provide/vod",
              "name": "æ°¸ä¹…èµ„æº",
              "is_adult": false
            },
            "bdzy": {
              "api": "https://api.1080zyku.com/inc/apijson_vod.php",
              "name": "ç™¾åº¦èµ„æº",
              "is_adult": false
            }
          }
        }
        EOF
        
    - name: Generate manifest
      run: |
        cat > public/manifest.json << 'EOF'
        {
          "name": "KatelyaTV",
          "short_name": "KatelyaTV",
          "description": "è·¨å¹³å°å½±è§†èšåˆæ’­æ”¾å™¨",
          "start_url": "/",
          "display": "standalone",
          "background_color": "#000000",
          "theme_color": "#000000",
          "icons": [
            {
              "src": "/favicon.ico",
              "sizes": "64x64 32x32 24x24 16x16",
              "type": "image/x-icon"
            }
          ]
        }
        EOF
        
    - name: Build application
      run: pnpm run build
      env:
        NODE_ENV: production
        NEXT_PUBLIC_STORAGE_TYPE: localstorage
        NEXT_PUBLIC_ENABLE_REGISTER: false
        PASSWORD: ${{ secrets.APP_PASSWORD || 'admin123' }}
        
    - name: Verify build output
      run: |
        echo "=== Build Verification ==="
        echo "Next.js build directory:"
        ls -la .next/
        echo ""
        
        if [ -d ".next/standalone" ]; then
          echo "âœ… Standalone build found"
          echo "Standalone contents:"
          ls -la .next/standalone/
          echo ""
          
          if [ -f ".next/standalone/server.js" ]; then
            echo "âœ… Server file found: $(ls -lh .next/standalone/server.js)"
          else
            echo "âŒ Server file missing!"
            exit 1
          fi
        else
          echo "âŒ Standalone build not found!"
          echo "This indicates the build configuration is incorrect."
          exit 1
        fi
        
        echo "Static files:"
        ls -la .next/static/ | head -10
        
    - name: Create deployment package
      run: |
        echo "=== Creating Deployment Package ==="
        
        # Create deployment directory
        mkdir -p deploy
        
        # Copy standalone server files
        echo "Copying standalone files..."
        cp -r .next/standalone/* deploy/
        
        # Copy static files to correct location
        echo "Copying static files..."
        mkdir -p deploy/.next
        cp -r .next/static deploy/.next/
        
        # Copy public files
        if [ -d "public" ]; then
          echo "Copying public files..."
          mkdir -p deploy/public
          cp -r public/* deploy/public/
        fi
        
        # Copy config
        cp config.production.json deploy/config.json
        
        # Create startup script
        cat > deploy/start.sh << 'EOF'
        #!/bin/bash
        export NODE_ENV=production
        export PORT=${PORT:-3000}
        export HOSTNAME=${HOSTNAME:-0.0.0.0}
        
        echo "Starting KatelyaTV server..."
        echo "Port: $PORT"
        echo "Hostname: $HOSTNAME"
        
        node server.js
        EOF
        chmod +x deploy/start.sh
        
        # Create process management script
        cat > deploy/manage.sh << 'EOF'
        #!/bin/bash
        
        case "$1" in
          start)
            echo "Starting KatelyaTV..."
            nohup ./start.sh > app.log 2>&1 &
            echo $! > app.pid
            echo "Started with PID: $(cat app.pid)"
            ;;
          stop)
            if [ -f app.pid ]; then
              PID=$(cat app.pid)
              kill $PID 2>/dev/null
              rm -f app.pid
              echo "Stopped KatelyaTV (PID: $PID)"
            else
              echo "No PID file found"
            fi
            ;;
          restart)
            $0 stop
            sleep 2
            $0 start
            ;;
          status)
            if [ -f app.pid ]; then
              PID=$(cat app.pid)
              if kill -0 $PID 2>/dev/null; then
                echo "KatelyaTV is running (PID: $PID)"
              else
                echo "PID file exists but process not running"
                rm -f app.pid
              fi
            else
              echo "KatelyaTV is not running"
            fi
            ;;
          logs)
            tail -f app.log
            ;;
          *)
            echo "Usage: $0 {start|stop|restart|status|logs}"
            exit 1
            ;;
        esac
        EOF
        chmod +x deploy/manage.sh
        
        # Create build info
        cat > deploy/build-info.txt << EOF
        Build Date: $(date)
        Commit: ${{ github.sha }}
        Build Mode: Standalone
        Node Version: $(node --version)
        Deployment Type: Node.js Application
        EOF
        
        # Remove unnecessary files to save space
        find deploy/ -name "*.map" -delete 2>/dev/null || true
        find deploy/ -name "*.test.js" -delete 2>/dev/null || true
        
        echo "=== Deployment Package Summary ==="
        echo "Package size: $(du -sh deploy | cut -f1)"
        echo "Key files:"
        ls -la deploy/
        echo ""
        echo "Server file: $(ls -lh deploy/server.js)"
        echo "Package.json: $(ls -lh deploy/package.json 2>/dev/null || echo 'Not found')"
        
    - name: Create deployment archive
      run: |
        cd deploy
        tar -czf ../katelyatv-deploy.tar.gz .
        cd ..
        
        echo "=== Archive Created ==="
        echo "Archive size: $(ls -lh katelyatv-deploy.tar.gz)"
        
    - name: Upload deployment artifact
      uses: actions/upload-artifact@v4
      with:
        name: katelyatv-deployment
        path: katelyatv-deploy.tar.gz
        retention-days: 30
        
    - name: Deployment Instructions
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo ""
        echo "ğŸ“¦ Deployment package: katelyatv-deploy.tar.gz"
        echo "ğŸ“Š Package size: $(ls -lh katelyatv-deploy.tar.gz | awk '{print $5}')"
        echo ""
        echo "ğŸš€ Deployment Steps:"
        echo "1. Download 'katelyatv-deployment' artifact"
        echo "2. Upload to server:"
        echo "   scp -P 2323 katelyatv-deploy.tar.gz igaqjbsf@server8.webhostmost.com:~/"
        echo "3. Deploy:"
        echo "   ssh -p 2323 igaqjbsf@server8.webhostmost.com"
        echo "   ./deploy-standalone.sh"
        echo ""
        echo "ğŸ® Management Commands:"
        echo "   ./manage.sh start    # Start application"
        echo "   ./manage.sh stop     # Stop application"
        echo "   ./manage.sh restart  # Restart application"
        echo "   ./manage.sh status   # Check status"
        echo "   ./manage.sh logs     # View logs"
        echo ""
        echo "ğŸŒ Access URL: https://wwwwwww.sylu.net"
